<Page x:Class="Forex.Wpf.Pages.Products.ProductPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:controls="clr-namespace:Forex.Wpf.Resources.UserControls"
      xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
      x:Name="RootPage"
      Title="ProductPage"
      d:DesignHeight="650"
      d:DesignWidth="1100"
      Background="{DynamicResource PrimaryBackground}"
      mc:Ignorable="d">

	<Grid Margin="10">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto" />
			<RowDefinition Height="Auto" />
			<RowDefinition Height="*" />
		</Grid.RowDefinitions>

		<DockPanel Grid.Row="0" LastChildFill="False">
			<Label
                Content="📦 Mahsulotlarni boshqarish"
                FontSize="18"
                FontWeight="Bold"
                Foreground="{StaticResource SecondaryTextColor}" />

			<Button DockPanel.Dock="Right"
                    x:Name="btnBack"
                    Padding="8,0"
                    md:ButtonAssist.CornerRadius="4"
                    md:ElevationAssist.Elevation="Dp24"
                    Background="{DynamicResource BackButtonBackground}"
                    BorderBrush="{StaticResource BackButtonBorder}"
                    Click="BtnBack_Click"
                    Content="🔙 Orqaga"
                    Foreground="{StaticResource BackButtonForeground}" />
		</DockPanel>

		<Grid Grid.Row="1" Margin="0,17,0,5">
			<Grid.ColumnDefinitions>
				<ColumnDefinition Width="120" />
				<ColumnDefinition Width="*" MaxWidth="120" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="*" />
				<ColumnDefinition Width="Auto" />
				<ColumnDefinition Width="Auto" />
				<ColumnDefinition Width="Auto" />
			</Grid.ColumnDefinitions>

			<controls:UserCalendar
                x:Name="date"
                Width="120"
                Height="32"
                HorizontalAlignment="Left"
                FontSize="16"
                SelectedDate="{Binding CurrentProductEntry.Date, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                <!-- Product -->
			<controls:FloatingImageComboBox 
                Grid.Column="1" Grid.ColumnSpan="2"
                Label="Mahsulot"
                Text="{Binding ProductCode, UpdateSourceTrigger=LostFocus}"
                ItemsSource="{Binding AvailableProducts}"
                Margin="2,0"
                SelectedItem="{Binding CurrentProduct, UpdateSourceTrigger=PropertyChanged}"
                x:Name="productCombo"
                IsEditable="True"
                IsSearchEnabled="True"
                ImageMemberPath="ImagePath"
                PrimaryTextMemberPath="Code"
                SecondaryTextMemberPath="Name"
                ShowImage="True"
                ImageWidth="50"
                ImageHeight="50"
                ItemHoverScale="2"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>

			<controls:FloatingInput
                x:Name="tbxCode"
                Grid.Column="1"
                Margin="2,0"
                Label="Kodi"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource BoolToVisibilityConverter}}"
                Text="{Binding CurrentProduct.Code, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<controls:FloatingInput
                x:Name="tbxName"
                Grid.Column="2"
                Margin="2,0"
                Label="Nomi"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource BoolToVisibilityConverter}}"
                Text="{Binding CurrentProduct.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
			<!-- Product -->

			<controls:FloatingComboBox
                x:Name="cbxProductionOrigin"
                Grid.Column="3"
                Margin="2,0"
                IsEnabled="{Binding IsProductionOriginEnabled}"
                ItemsSource="{Binding ProductionOrigins}"
                Label="Tayyorlanish usuli"
                SelectedItem="{Binding CurrentProductEntry.ProductionOrigin, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<!-- Type -->
			<controls:FloatingComboBox
                x:Name="cbxProductType"
                Grid.Column="4"
                Margin="2,0"
                DisplayMemberPath="Type"
                IsEditable="True"
                ItemsSource="{Binding CurrentProduct.ProductTypes}"
                Label="Razmer"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                SelectedItem="{Binding CurrentProduct.SelectedType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Text="{Binding ProductType, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" />

			<controls:FloatingInput
                x:Name="tbxRazmer"
                Grid.Column="4"
                Margin="2,0"
                Label="Razmer"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource BoolToVisibilityConverter}}"
                Text="{Binding CurrentProduct.SelectedType.Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
			<!-- Type -->

			<controls:FloatingInput
                x:Name="tbxBundle"
                Grid.Column="5"
                Margin="2,0"
                Label="Qop soni"
                Text="{Binding CurrentProductEntry.BundleCount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<controls:FloatingInput
                x:Name="tbxBundleItemCount"
                Grid.Column="6"
                Margin="2,0"
                Label="Donasi"
                IsReadOnly="{Binding CurrentProduct.SelectedType.Id, Converter={StaticResource NumberToBoolConverter}}"
                Text="{Binding CurrentProductEntry.BundleItemCount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<controls:FloatingInput
                x:Name="tbxQuantity"
                Grid.Column="7"
                Margin="2,0"
                IsReadOnly="True"
                Label="Jami soni"
                Text="{Binding CurrentProductEntry.Count, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<controls:FloatingInput
                x:Name="tbxCostPrice"
                Grid.Column="8"
                Margin="2,0"
                Label="Tan narxi"
                Text="{Binding CurrentProductEntry.UnitPrice, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat={}{0:N0}}" />

			<controls:FloatingFileInput
                x:Name="fileInput"
                Grid.Column="9"
                Margin="2,0"
                MinWidth="100"
                MaxWidth="150"
                Label="Rasm"
                Visibility="{Binding IsNewProductMode, Converter={StaticResource BoolToVisibilityConverter}}"
                FileName="{Binding CurrentProduct.ImagePath, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

			<Button
                x:Name="btnAdd"
                Grid.Column="10"
                Height="30"
                Margin="2,0,0,0"
                md:ButtonAssist.CornerRadius="4"
                Background="{DynamicResource OtherBackground}"
                Command="{Binding SaveCommand}"
                Content="Saqlash"
                FontSize="14" />

			<Button
                x:Name="btnCancel"
                Grid.Column="11"
                Height="30"
                Margin="2,0,0,0"
                md:ButtonAssist.CornerRadius="4"
                Background="#FF6B6B"
                BorderBrush="#D32F2F"
                Command="{Binding CancelCommand}"
                Content="Bekor qilish"
                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                FontSize="14" />
		</Grid>

		<DataGrid Grid.Row="2"
                x:Name="dataGrid"
                AutoGenerateColumns="False"
                BorderThickness="2"
                CanUserAddRows="False"
                CanUserDeleteRows="False"
                FontSize="14"
                VirtualizingStackPanel.VirtualizationMode="Standard"
                EnableRowVirtualization="True"
                ItemsSource="{Binding ProductEntries}"
                SelectedItem="{Binding SelectedProductEntry}"
                SelectionMode="Single"
                SelectionUnit="FullRow"
                AlternatingRowBackground="#F9F9F9"
                HeadersVisibility="Column"
                IsReadOnly="True"
                ScrollViewer.ScrollChanged="DataGrid_ScrollChanged">

			<DataGrid.Resources>
				<Style x:Key="RightAlignedCellStyle" TargetType="TextBlock">
					<Setter Property="TextAlignment" Value="Right" />
					<Setter Property="Padding" Value="0,0,5,0" />
				</Style>

				<Style x:Key="CenterAlignedCellStyle" TargetType="TextBlock">
					<Setter Property="TextAlignment" Value="Center" />
				</Style>

				<Style TargetType="DataGridColumnHeader">
					<Setter Property="HorizontalContentAlignment" Value="Center" />
					<Setter Property="FontWeight" Value="SemiBold" />
				</Style>
			</DataGrid.Resources>

			<DataGrid.Columns>
				<DataGridTemplateColumn Width="60" Header="T/r">
					<DataGridTemplateColumn.CellTemplate>
						<DataTemplate>
							<TextBlock HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       Text="{Binding RelativeSource={RelativeSource AncestorType=DataGridRow},
                                       Converter={StaticResource IndexConverter}}" />
						</DataTemplate>
					</DataGridTemplateColumn.CellTemplate>
				</DataGridTemplateColumn>
				<DataGridTextColumn
                        Width="100"
                        Binding="{Binding Date, Mode=TwoWay, StringFormat={}{0:dd.MM.yyyy}}"
                        ElementStyle="{StaticResource CenterAlignedCellStyle}"
                        Header="Sana" />

				<DataGridTextColumn
                        Width="100"
                        Binding="{Binding ProductType.Product.Code, Mode=TwoWay}"
                        Header="Kod" />

				<DataGridTextColumn
                        Width="1.3*"
                        MinWidth="100"
                        Binding="{Binding ProductType.Product.Name}"
                        Header="Nomi" />

				<DataGridTextColumn
                        Width="*"
                        MinWidth="100"
                        Binding="{Binding ProductionOrigin}"
                        ElementStyle="{StaticResource CenterAlignedCellStyle}"
                        Header="Tayyorlanish usuli" />

				<DataGridTextColumn
                        Width="*"
                        Binding="{Binding ProductType.Type}"
                        ElementStyle="{StaticResource CenterAlignedCellStyle}"
                        Header="Razmer" />

				<DataGridTextColumn
                        Width="*"
                        Binding="{Binding BundleCount, StringFormat={}{0:N0}}"
                        ElementStyle="{StaticResource RightAlignedCellStyle}"
                        Header="Qop soni" />

				<DataGridTextColumn
                        Width="*"
                        Binding="{Binding BundleItemCount, StringFormat={}{0:N0}}"
                        ElementStyle="{StaticResource RightAlignedCellStyle}"
                        Header="Donasi" />

				<DataGridTextColumn
                        Width="*"
                        Binding="{Binding Count, StringFormat={}{0:N0}}"
                        ElementStyle="{StaticResource RightAlignedCellStyle}"
                        Header="Jami soni" />

				<DataGridTextColumn
                        Width="*"
                        Binding="{Binding UnitPrice, StringFormat={}{0:N0}}"
                        ElementStyle="{StaticResource RightAlignedCellStyle}"
                        Header="Tannarxi" />

				<DataGridTemplateColumn Width="90" Header="Amallar">
					<DataGridTemplateColumn.HeaderStyle>
						<Style TargetType="DataGridColumnHeader">
							<Setter Property="HorizontalContentAlignment" Value="Center" />
							<Setter Property="FontWeight" Value="SemiBold" />
						</Style>
					</DataGridTemplateColumn.HeaderStyle>
					<DataGridTemplateColumn.CellStyle>
						<Style TargetType="DataGridCell">
							<Setter Property="Padding" Value="4"/>
							<Setter Property="Template">
								<Setter.Value>
									<ControlTemplate TargetType="DataGridCell">
										<StackPanel
                                                Orientation="Horizontal"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center">

											<Button Width="30"
                                                    Height="26"
                                                    Margin="2,0"
                                                    Padding="0"
                                                    Background="#FFB300"
                                                    Foreground="White"
                                                    FontWeight="Bold"
                                                    FontSize="12"
                                                    ToolTip="Tahrirlash"
                                                    Command="{Binding DataContext.EditCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}">
												<md:PackIcon Kind="Pencil" Width="16" Height="16"/>
											</Button>

											<Button Width="30"
                                                    Height="26"
                                                    Margin="2,0"
                                                    Padding="0"
                                                    Background="#D32F2F"
                                                    Foreground="White"
                                                    FontWeight="Bold"
                                                    FontSize="12"
                                                    ToolTip="O'chirish"
                                                    Command="{Binding DataContext.DeleteCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                    CommandParameter="{Binding}">
												<md:PackIcon Kind="Delete" Width="16" Height="16"/>
											</Button>
										</StackPanel>
									</ControlTemplate>
								</Setter.Value>
							</Setter>
						</Style>
					</DataGridTemplateColumn.CellStyle>
				</DataGridTemplateColumn>
			</DataGrid.Columns>
		</DataGrid>
	</Grid>
</Page>